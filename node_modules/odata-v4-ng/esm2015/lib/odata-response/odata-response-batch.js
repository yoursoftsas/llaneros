/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { HttpHeaders, HttpResponse } from '@angular/common/http';
import { Utils } from '../utils/utils';
import { ODataResponse } from './odata-response';
import { ODataResponseAbstract } from './odata-response-abstract';
export class ODataResponseBatch extends ODataResponseAbstract {
    /**
     * @param {?} httpResponse
     */
    constructor(httpResponse) {
        super(httpResponse);
        this.odataResponses = [];
        this.parseResponses();
    }
    /**
     * @return {?}
     */
    getODataResponses() {
        return this.odataResponses;
    }
    /**
     * @return {?}
     */
    parseResponses() {
        /** @type {?} */
        const contentType = this.getHttpResponse().headers.get(ODataResponseBatch.CONTENT_TYPE);
        /** @type {?} */
        const boundaryDelimiterBatch = this.getBoundaryDelimiter(contentType);
        /** @type {?} */
        const boundaryEndBatch = this.getBoundaryEnd(boundaryDelimiterBatch);
        /** @type {?} */
        const batchBody = this.getBodyAsText();
        /** @type {?} */
        const batchBodyLines = batchBody.split(ODataResponseBatch.NEWLINE);
        /** @type {?} */
        let odataResponseCS;
        /** @type {?} */
        let contentId;
        /** @type {?} */
        let boundaryDelimiterCS;
        /** @type {?} */
        let boundaryEndCS;
        /** @type {?} */
        let batchPartStartIndex;
        for (let index = 0; index < batchBodyLines.length; index++) {
            /** @type {?} */
            const batchBodyLine = batchBodyLines[index];
            if (batchBodyLine.startsWith(ODataResponseBatch.CONTENT_TYPE)) {
                /** @type {?} */
                const contentTypeValue = this.getHeaderValue(batchBodyLine);
                if (contentTypeValue === ODataResponseBatch.MULTIPART_MIXED) {
                    odataResponseCS = [];
                    contentId = undefined;
                    boundaryDelimiterCS = this.getBoundaryDelimiter(batchBodyLine);
                    boundaryEndCS = this.getBoundaryEnd(boundaryDelimiterCS);
                    batchPartStartIndex = undefined;
                }
                continue;
            }
            else if (Utils.isNotNullNorUndefined(odataResponseCS) && batchBodyLine.startsWith(ODataResponseBatch.CONTENT_ID)) {
                contentId = Number(this.getHeaderValue(batchBodyLine));
            }
            else if (batchBodyLine.startsWith(ODataResponseBatch.HTTP11)) {
                batchPartStartIndex = index;
            }
            else if (batchBodyLine === boundaryDelimiterBatch || batchBodyLine === boundaryDelimiterCS
                || batchBodyLine === boundaryEndBatch || batchBodyLine === boundaryEndCS) {
                if (!batchPartStartIndex) {
                    continue;
                }
                /** @type {?} */
                const odataResponse = this.createODataResponse(batchBodyLines, batchPartStartIndex, index - 1);
                if (Utils.isNotNullNorUndefined(odataResponseCS)) {
                    odataResponseCS[contentId] = odataResponse;
                }
                else {
                    this.odataResponses.push(odataResponse);
                }
                if (batchBodyLine === boundaryDelimiterBatch || batchBodyLine === boundaryDelimiterCS) {
                    batchPartStartIndex = index + 1;
                }
                else if (batchBodyLine === boundaryEndBatch || batchBodyLine === boundaryEndCS) {
                    if (Utils.isNotNullNorUndefined(odataResponseCS)) {
                        for (const response of odataResponseCS) {
                            if (Utils.isNotNullNorUndefined(response)) {
                                this.odataResponses.push(response);
                            }
                        }
                    }
                    odataResponseCS = undefined;
                    boundaryDelimiterCS = undefined;
                    boundaryEndCS = undefined;
                    batchPartStartIndex = undefined;
                }
            }
        }
    }
    /**
     * @param {?} header
     * @return {?}
     */
    getHeaderValue(header) {
        /** @type {?} */
        let res = header.split(';')[0].trim();
        res = res.split(':')[1].trim();
        return res;
    }
    /**
     * @param {?} contentType
     * @return {?}
     */
    getBoundaryDelimiter(contentType) {
        /** @type {?} */
        const contentTypeParts = contentType.split(';');
        if (contentTypeParts.length === 2) {
            /** @type {?} */
            const boundary = contentType.split(';')[1].trim();
            /** @type {?} */
            const boundaryDelimiter = ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX + boundary.split('=')[1];
            return boundaryDelimiter;
        }
        else {
            return '';
        }
    }
    /**
     * @param {?} boundaryDelimiter
     * @return {?}
     */
    getBoundaryEnd(boundaryDelimiter) {
        if (!boundaryDelimiter.length) {
            return '';
        }
        /** @type {?} */
        const boundaryEnd = boundaryDelimiter + ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX;
        return boundaryEnd;
    }
    /**
     * @param {?} batchBodyLines
     * @param {?} batchPartStartIndex
     * @param {?} batchPartEndIndex
     * @return {?}
     */
    createODataResponse(batchBodyLines, batchPartStartIndex, batchPartEndIndex) {
        /** @type {?} */
        let index = batchPartStartIndex;
        /** @type {?} */
        const statusLine = batchBodyLines[index];
        /** @type {?} */
        const statusLineParts = batchBodyLines[index].split(' ');
        /** @type {?} */
        const status = statusLineParts[1];
        /** @type {?} */
        const statusTextIndex = statusLine.indexOf(status) + status.length + 1;
        /** @type {?} */
        const statusText = statusLine.substring(statusTextIndex);
        /** @type {?} */
        let httpHeaders = new HttpHeaders();
        for (++index; index <= batchPartEndIndex; index++) {
            /** @type {?} */
            const batchBodyLine = batchBodyLines[index];
            if (batchBodyLine === '') {
                break;
            }
            /** @type {?} */
            const batchBodyLineParts = batchBodyLine.split(': ');
            httpHeaders = httpHeaders.append(batchBodyLineParts[0].trim(), batchBodyLineParts[1].trim());
        }
        /** @type {?} */
        let body = '';
        for (; index <= batchPartEndIndex; index++) {
            body += batchBodyLines[index];
        }
        return new ODataResponse(new HttpResponse({
            body: body,
            headers: httpHeaders,
            status: Number(status),
            statusText: statusText
        }));
    }
}
ODataResponseBatch.CONTENT_TYPE = 'Content-Type';
ODataResponseBatch.CONTENT_ID = 'Content-ID';
ODataResponseBatch.HTTP11 = 'HTTP/1.1';
ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX = '--';
ODataResponseBatch.NEWLINE = '\r\n';
ODataResponseBatch.MULTIPART_MIXED = 'multipart/mixed';
if (false) {
    /** @type {?} */
    ODataResponseBatch.CONTENT_TYPE;
    /** @type {?} */
    ODataResponseBatch.CONTENT_ID;
    /** @type {?} */
    ODataResponseBatch.HTTP11;
    /** @type {?} */
    ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX;
    /** @type {?} */
    ODataResponseBatch.NEWLINE;
    /** @type {?} */
    ODataResponseBatch.MULTIPART_MIXED;
    /** @type {?} */
    ODataResponseBatch.prototype.odataResponses;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGEtcmVzcG9uc2UtYmF0Y2guanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vZGF0YS12NC1uZy8iLCJzb3VyY2VzIjpbImxpYi9vZGF0YS1yZXNwb25zZS9vZGF0YS1yZXNwb25zZS1iYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRWxFLE1BQU0seUJBQTBCLFNBQVEscUJBQXFCOzs7O0lBVXpELFlBQVksWUFBa0M7UUFDMUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztLQUN6Qjs7OztJQUVELGlCQUFpQjtRQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO0tBQzlCOzs7O0lBRVMsY0FBYzs7UUFDcEIsTUFBTSxXQUFXLEdBQVcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLENBQUM7O1FBQ2hHLE1BQU0sc0JBQXNCLEdBQVcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDOztRQUM5RSxNQUFNLGdCQUFnQixHQUFXLElBQUksQ0FBQyxjQUFjLENBQUMsc0JBQXNCLENBQUMsQ0FBQzs7UUFFN0UsTUFBTSxTQUFTLEdBQVcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDOztRQUMvQyxNQUFNLGNBQWMsR0FBYSxTQUFTLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFD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LEdBQWEsYUFBYSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvRCxXQUFXLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ2hHOztRQUVELElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNkLEdBQUcsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLGlCQUFpQixFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDekMsSUFBSSxJQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNqQztRQUVELE1BQU0sQ0FBQyxJQUFJLGFBQWEsQ0FBQyxJQUFJLFlBQVksQ0FBQztZQUN0QyxJQUFJLEVBQUUsSUFBSTtZQUNWLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ3RCLFVBQVUsRUFBRSxVQUFVO1NBQ3pCLENBQUMsQ0FBQyxDQUFDO0tBQ1A7O2tDQXpJc0MsY0FBYztnQ0FDaEIsWUFBWTs0QkFDaEIsVUFBVTs0Q0FDTSxJQUFJOzZCQUNuQixNQUFNO3FDQUNFLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBIZWFkZXJzLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuaW1wb3J0IHsgT0RhdGFSZXNwb25zZSB9IGZyb20gJy4vb2RhdGEtcmVzcG9uc2UnO1xuaW1wb3J0IHsgT0RhdGFSZXNwb25zZUFic3RyYWN0IH0gZnJvbSAnLi9vZGF0YS1yZXNwb25zZS1hYnN0cmFjdCc7XG5cbmV4cG9ydCBjbGFzcyBPRGF0YVJlc3BvbnNlQmF0Y2ggZXh0ZW5kcyBPRGF0YVJlc3BvbnNlQWJzdHJhY3Qge1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IENPTlRFTlRfVFlQRSA9ICdDb250ZW50LVR5cGUnO1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IENPTlRFTlRfSUQgPSAnQ29udGVudC1JRCc7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgSFRUUDExID0gJ0hUVFAvMS4xJztcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBCT1VOREFSWV9QUkVGSVhfU1VGRklYID0gJy0tJztcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBORVdMSU5FID0gJ1xcclxcbic7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTVVMVElQQVJUX01JWEVEID0gJ211bHRpcGFydC9taXhlZCc7XG5cbiAgICBwcml2YXRlIG9kYXRhUmVzcG9uc2VzOiBPRGF0YVJlc3BvbnNlW107XG5cbiAgICBjb25zdHJ1Y3RvcihodHRwUmVzcG9uc2U6IEh0dHBSZXNwb25zZTxzdHJpbmc+KSB7XG4gICAgICAgIHN1cGVyKGh0dHBSZXNwb25zZSk7XG4gICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMgPSBbXTtcbiAgICAgICAgdGhpcy5wYXJzZVJlc3BvbnNlcygpO1xuICAgIH1cblxuICAgIGdldE9EYXRhUmVzcG9uc2VzKCk6IE9EYXRhUmVzcG9uc2VbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9kYXRhUmVzcG9uc2VzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZVJlc3BvbnNlcygpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGVudFR5cGU6IHN0cmluZyA9IHRoaXMuZ2V0SHR0cFJlc3BvbnNlKCkuaGVhZGVycy5nZXQoT0RhdGFSZXNwb25zZUJhdGNoLkNPTlRFTlRfVFlQRSk7XG4gICAgICAgIGNvbnN0IGJvdW5kYXJ5RGVsaW1pdGVyQmF0Y2g6IHN0cmluZyA9IHRoaXMuZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoY29udGVudFR5cGUpO1xuICAgICAgICBjb25zdCBib3VuZGFyeUVuZEJhdGNoOiBzdHJpbmcgPSB0aGlzLmdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyQmF0Y2gpO1xuXG4gICAgICAgIGNvbnN0IGJhdGNoQm9keTogc3RyaW5nID0gdGhpcy5nZXRCb2R5QXNUZXh0KCk7XG4gICAgICAgIGNvbnN0IGJhdGNoQm9keUxpbmVzOiBzdHJpbmdbXSA9IGJhdGNoQm9keS5zcGxpdChPRGF0YVJlc3BvbnNlQmF0Y2guTkVXTElORSk7XG5cbiAgICAgICAgbGV0IG9kYXRhUmVzcG9uc2VDUzogT0RhdGFSZXNwb25zZVtdO1xuICAgICAgICBsZXQgY29udGVudElkOiBudW1iZXI7XG4gICAgICAgIGxldCBib3VuZGFyeURlbGltaXRlckNTO1xuICAgICAgICBsZXQgYm91bmRhcnlFbmRDUztcbiAgICAgICAgbGV0IGJhdGNoUGFydFN0YXJ0SW5kZXg7XG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBiYXRjaEJvZHlMaW5lcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICAgIGNvbnN0IGJhdGNoQm9keUxpbmU6IHN0cmluZyA9IGJhdGNoQm9keUxpbmVzW2luZGV4XTtcblxuICAgICAgICAgICAgaWYgKGJhdGNoQm9keUxpbmUuc3RhcnRzV2l0aChPRGF0YVJlc3BvbnNlQmF0Y2guQ09OVEVOVF9UWVBFKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlVmFsdWU6IHN0cmluZyA9IHRoaXMuZ2V0SGVhZGVyVmFsdWUoYmF0Y2hCb2R5TGluZSk7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlVmFsdWUgPT09IE9EYXRhUmVzcG9uc2VCYXRjaC5NVUxUSVBBUlRfTUlYRUQpIHtcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXNwb25zZUNTID0gW107XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlEZWxpbWl0ZXJDUyA9IHRoaXMuZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoYmF0Y2hCb2R5TGluZSk7XG4gICAgICAgICAgICAgICAgICAgIGJvdW5kYXJ5RW5kQ1MgPSB0aGlzLmdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyQ1MpO1xuICAgICAgICAgICAgICAgICAgICBiYXRjaFBhcnRTdGFydEluZGV4ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoVXRpbHMuaXNOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUmVzcG9uc2VDUykgJiYgYmF0Y2hCb2R5TGluZS5zdGFydHNXaXRoKE9EYXRhUmVzcG9uc2VCYXRjaC5DT05URU5UX0lEKSkge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRJZCA9IE51bWJlcih0aGlzLmdldEhlYWRlclZhbHVlKGJhdGNoQm9keUxpbmUpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmF0Y2hCb2R5TGluZS5zdGFydHNXaXRoKE9EYXRhUmVzcG9uc2VCYXRjaC5IVFRQMTEpKSB7XG4gICAgICAgICAgICAgICAgYmF0Y2hQYXJ0U3RhcnRJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeURlbGltaXRlckJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RGVsaW1pdGVyQ1NcbiAgICAgICAgICAgICAgICB8fCBiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeUVuZEJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RW5kQ1MpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWJhdGNoUGFydFN0YXJ0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3Qgb2RhdGFSZXNwb25zZTogT0RhdGFSZXNwb25zZSA9IHRoaXMuY3JlYXRlT0RhdGFSZXNwb25zZShiYXRjaEJvZHlMaW5lcywgYmF0Y2hQYXJ0U3RhcnRJbmRleCwgaW5kZXggLSAxKTtcbiAgICAgICAgICAgICAgICBpZiAoVXRpbHMuaXNOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUmVzcG9uc2VDUykpIHtcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXNwb25zZUNTW2NvbnRlbnRJZF0gPSBvZGF0YVJlc3BvbnNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMucHVzaChvZGF0YVJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoYmF0Y2hCb2R5TGluZSA9PT0gYm91bmRhcnlEZWxpbWl0ZXJCYXRjaCB8fCBiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeURlbGltaXRlckNTKSB7XG4gICAgICAgICAgICAgICAgICAgIGJhdGNoUGFydFN0YXJ0SW5kZXggPSBpbmRleCArIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeUVuZEJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RW5kQ1MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFV0aWxzLmlzTm90TnVsbE5vclVuZGVmaW5lZChvZGF0YVJlc3BvbnNlQ1MpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlc3BvbnNlIG9mIG9kYXRhUmVzcG9uc2VDUykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChVdGlscy5pc05vdE51bGxOb3JVbmRlZmluZWQocmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMucHVzaChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVzcG9uc2VDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlEZWxpbWl0ZXJDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlFbmRDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYmF0Y2hQYXJ0U3RhcnRJbmRleCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0SGVhZGVyVmFsdWUoaGVhZGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgcmVzOiBzdHJpbmcgPSBoZWFkZXIuc3BsaXQoJzsnKVswXS50cmltKCk7XG4gICAgICAgIHJlcyA9IHJlcy5zcGxpdCgnOicpWzFdLnRyaW0oKTtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoY29udGVudFR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlUGFydHM6IHN0cmluZ1tdID0gY29udGVudFR5cGUuc3BsaXQoJzsnKTtcbiAgICAgICAgaWYgKGNvbnRlbnRUeXBlUGFydHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICBjb25zdCBib3VuZGFyeTogc3RyaW5nID0gY29udGVudFR5cGUuc3BsaXQoJzsnKVsxXS50cmltKCk7XG4gICAgICAgICAgICBjb25zdCBib3VuZGFyeURlbGltaXRlcjogc3RyaW5nID0gT0RhdGFSZXNwb25zZUJhdGNoLkJPVU5EQVJZX1BSRUZJWF9TVUZGSVggKyBib3VuZGFyeS5zcGxpdCgnPScpWzFdO1xuICAgICAgICAgICAgcmV0dXJuIGJvdW5kYXJ5RGVsaW1pdGVyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAoIWJvdW5kYXJ5RGVsaW1pdGVyLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJvdW5kYXJ5RW5kOiBzdHJpbmcgPSBib3VuZGFyeURlbGltaXRlciArIE9EYXRhUmVzcG9uc2VCYXRjaC5CT1VOREFSWV9QUkVGSVhfU1VGRklYO1xuICAgICAgICByZXR1cm4gYm91bmRhcnlFbmQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZU9EYXRhUmVzcG9uc2UoYmF0Y2hCb2R5TGluZXM6IHN0cmluZ1tdLCBiYXRjaFBhcnRTdGFydEluZGV4OiBudW1iZXIsIGJhdGNoUGFydEVuZEluZGV4OiBudW1iZXIpOiBPRGF0YVJlc3BvbnNlIHtcbiAgICAgICAgbGV0IGluZGV4OiBudW1iZXIgPSBiYXRjaFBhcnRTdGFydEluZGV4O1xuICAgICAgICBjb25zdCBzdGF0dXNMaW5lOiBzdHJpbmcgPSBiYXRjaEJvZHlMaW5lc1tpbmRleF07XG4gICAgICAgIGNvbnN0IHN0YXR1c0xpbmVQYXJ0czogc3RyaW5nW10gPSBiYXRjaEJvZHlMaW5lc1tpbmRleF0uc3BsaXQoJyAnKTtcbiAgICAgICAgY29uc3Qgc3RhdHVzOiBzdHJpbmcgPSBzdGF0dXNMaW5lUGFydHNbMV07XG4gICAgICAgIGNvbnN0IHN0YXR1c1RleHRJbmRleCA9IHN0YXR1c0xpbmUuaW5kZXhPZihzdGF0dXMpICsgc3RhdHVzLmxlbmd0aCArIDE7XG4gICAgICAgIGNvbnN0IHN0YXR1c1RleHQ6IHN0cmluZyA9IHN0YXR1c0xpbmUuc3Vic3RyaW5nKHN0YXR1c1RleHRJbmRleCk7XG5cbiAgICAgICAgbGV0IGh0dHBIZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgICAgICBmb3IgKCsraW5kZXg7IGluZGV4IDw9IGJhdGNoUGFydEVuZEluZGV4OyBpbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaEJvZHlMaW5lOiBzdHJpbmcgPSBiYXRjaEJvZHlMaW5lc1tpbmRleF07XG5cbiAgICAgICAgICAgIGlmIChiYXRjaEJvZHlMaW5lID09PSAnJykge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBiYXRjaEJvZHlMaW5lUGFydHM6IHN0cmluZ1tdID0gYmF0Y2hCb2R5TGluZS5zcGxpdCgnOiAnKTtcbiAgICAgICAgICAgIGh0dHBIZWFkZXJzID0gaHR0cEhlYWRlcnMuYXBwZW5kKGJhdGNoQm9keUxpbmVQYXJ0c1swXS50cmltKCksIGJhdGNoQm9keUxpbmVQYXJ0c1sxXS50cmltKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJvZHkgPSAnJztcbiAgICAgICAgZm9yICg7IGluZGV4IDw9IGJhdGNoUGFydEVuZEluZGV4OyBpbmRleCsrKSB7XG4gICAgICAgICAgICBib2R5ICs9IGJhdGNoQm9keUxpbmVzW2luZGV4XTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgT0RhdGFSZXNwb25zZShuZXcgSHR0cFJlc3BvbnNlKHtcbiAgICAgICAgICAgIGJvZHk6IGJvZHksXG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVycyxcbiAgICAgICAgICAgIHN0YXR1czogTnVtYmVyKHN0YXR1cyksXG4gICAgICAgICAgICBzdGF0dXNUZXh0OiBzdGF0dXNUZXh0XG4gICAgICAgIH0pKTtcbiAgICB9XG59XG4iXX0=