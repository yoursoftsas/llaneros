/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { HttpHeaders } from '@angular/common/http';
import { UUID } from 'angular2-uuid';
import { Utils } from '../utils/utils';
import { ODataQueryAbstract } from './odata-query-abstract';
/** @enum {number} */
const Method = {
    GET: 0, POST: 1, PUT: 2, PATCH: 3, DELETE: 4,
};
export { Method };
Method[Method.GET] = 'GET';
Method[Method.POST] = 'POST';
Method[Method.PUT] = 'PUT';
Method[Method.PATCH] = 'PATCH';
Method[Method.DELETE] = 'DELETE';
export class BatchRequest {
    /**
     * @param {?} method
     * @param {?} odataQuery
     * @param {?=} body
     * @param {?=} httpOptions
     */
    constructor(method, odataQuery, body, httpOptions) {
        this.method = method;
        this.odataQuery = odataQuery;
        this.body = body;
        this.httpOptions = httpOptions;
    }
}
if (false) {
    /** @type {?} */
    BatchRequest.prototype.method;
    /** @type {?} */
    BatchRequest.prototype.odataQuery;
    /** @type {?} */
    BatchRequest.prototype.body;
    /** @type {?} */
    BatchRequest.prototype.httpOptions;
}
export class ODataQueryBatch extends ODataQueryAbstract {
    /**
     * @param {?} odataService
     * @param {?} serviceRoot
     */
    constructor(odataService, serviceRoot) {
        super(odataService, serviceRoot);
        Utils.requireNotNullNorUndefined(odataService, 'odataService');
        Utils.requireNotNullNorUndefined(serviceRoot, 'serviceRoot');
        Utils.requireNotEmpty(serviceRoot, 'serviceRoot');
        this.queryString = Utils.appendSegment(serviceRoot, ODataQueryBatch.$BATCH);
        this.requests = [];
        this.batchBoundary = ODataQueryBatch.BATCH_PREFIX + this.getUUID();
        this.changesetBoundary = null;
        this.changesetID = 1;
    }
    /**
     * @param {?} odataQuery
     * @param {?=} httpOptions
     * @return {?}
     */
    get(odataQuery, httpOptions) {
        Utils.requireNotNullNorUndefined(odataQuery, 'odataQuery');
        this.requests.push(new BatchRequest(Method.GET, odataQuery, undefined, httpOptions));
        return this;
    }
    /**
     * @param {?} odataQuery
     * @param {?} body
     * @param {?=} httpOptions
     * @return {?}
     */
    post(odataQuery, body, httpOptions) {
        Utils.requireNotNullNorUndefined(odataQuery, 'odataQuery');
        this.requests.push(new BatchRequest(Method.POST, odataQuery, body, httpOptions));
        return this;
    }
    /**
     * @param {?} odataQuery
     * @param {?} body
     * @param {?=} httpOptions
     * @return {?}
     */
    put(odataQuery, body, httpOptions) {
        Utils.requireNotNullNorUndefined(odataQuery, 'odataQuery');
        this.requests.push(new BatchRequest(Method.PUT, odataQuery, body, httpOptions));
        return this;
    }
    /**
     * @param {?} odataQuery
     * @param {?} body
     * @param {?=} httpOptions
     * @return {?}
     */
    patch(odataQuery, body, httpOptions) {
        Utils.requireNotNullNorUndefined(odataQuery, 'odataQuery');
        this.requests.push(new BatchRequest(Method.PATCH, odataQuery, body, httpOptions));
        return this;
    }
    /**
     * @param {?} odataQuery
     * @param {?=} httpOptions
     * @return {?}
     */
    delete(odataQuery, httpOptions) {
        Utils.requireNotNullNorUndefined(odataQuery, 'odataQuery');
        this.requests.push(new BatchRequest(Method.DELETE, odataQuery, undefined, httpOptions));
        return this;
    }
    /**
     * @param {?=} httpOptions
     * @return {?}
     */
    execute(httpOptions) {
        // set headers
        if (Utils.isNullOrUndefined(httpOptions)) {
            httpOptions = {};
        }
        if (Utils.isNullOrUndefined(httpOptions.headers)) {
            httpOptions.headers = new HttpHeaders();
        }
        httpOptions.headers = httpOptions.headers.set(ODataQueryBatch.ODATA_VERSION, ODataQueryBatch.VERSION_4_0);
        httpOptions.headers = httpOptions.headers.set(ODataQueryBatch.CONTENT_TYPE, ODataQueryBatch.MULTIPART_MIXED_BOUNDARY + this.batchBoundary);
        httpOptions.headers = httpOptions.headers.set(ODataQueryBatch.ACCEPT, ODataQueryBatch.MULTIPART_MIXED);
        // send request
        return this.odataService.post(this, this.getBody(), httpOptions);
    }
    /**
     * @return {?}
     */
    toString() {
        return this.queryString;
    }
    /**
     * @return {?}
     */
    getBody() {
        /** @type {?} */
        let res = '';
        for (const request of this.requests) {
            /** @type {?} */
            const method = request.method;
            /** @type {?} */
            const odataQuery = request.odataQuery;
            /** @type {?} */
            const httpOptions = request.httpOptions;
            /** @type {?} */
            const body = request.body;
            // if method is GET and there is a changeset boundary open then close it
            if (method === Method.GET && Utils.isNotNullNorUndefined(this.changesetBoundary)) {
                res += ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + this.changesetBoundary + ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + ODataQueryBatch.NEWLINE;
                this.changesetBoundary = null;
            }
            // if there is no changeset boundary open then open a batch boundary
            if (Utils.isNullOrUndefined(this.changesetBoundary)) {
                res += ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + this.batchBoundary + ODataQueryBatch.NEWLINE;
            }
            // if method is not GET and there is no changeset boundary open then open a changeset boundary
            if (method !== Method.GET) {
                if (Utils.isNullOrUndefined(this.changesetBoundary)) {
                    this.changesetBoundary = ODataQueryBatch.CHANGESET_PREFIX + this.getUUID();
                    res += ODataQueryBatch.CONTENT_TYPE + ': ' + ODataQueryBatch.MULTIPART_MIXED_BOUNDARY + this.changesetBoundary + ODataQueryBatch.NEWLINE;
                    res += ODataQueryBatch.NEWLINE;
                }
                res += ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + this.changesetBoundary + ODataQueryBatch.NEWLINE;
            }
            res += ODataQueryBatch.CONTENT_TYPE + ': ' + ODataQueryBatch.APPLICATION_HTTP + ODataQueryBatch.NEWLINE;
            res += ODataQueryBatch.CONTENT_TRANSFER_ENCODING + ': ' + ODataQueryBatch.BINARY + ODataQueryBatch.NEWLINE;
            if (method !== Method.GET) {
                res += ODataQueryBatch.CONTENT_ID + ': ' + this.changesetID++ + ODataQueryBatch.NEWLINE;
            }
            res += ODataQueryBatch.NEWLINE;
            res += Method[method] + ' ' + odataQuery + ' ' + ODataQueryBatch.HTTP11 + ODataQueryBatch.NEWLINE;
            res += this.getHeaders(method, httpOptions);
            res += ODataQueryBatch.NEWLINE;
            if (method === Method.GET || method === Method.DELETE) {
                res += ODataQueryBatch.NEWLINE;
            }
            else {
                res += JSON.stringify(body) + ODataQueryBatch.NEWLINE;
            }
        }
        if (res.length) {
            if (Utils.isNotNullNorUndefined(this.changesetBoundary)) {
                res += ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + this.changesetBoundary + ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + ODataQueryBatch.NEWLINE;
                this.changesetBoundary = null;
            }
            res += ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX + this.batchBoundary + ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX;
        }
        return res;
    }
    /**
     * @param {?} method
     * @param {?} httpOptions
     * @return {?}
     */
    getHeaders(method, httpOptions) {
        /** @type {?} */
        let res = '';
        if (method === Method.POST || method === Method.PATCH || method === Method.PUT) {
            res += ODataQueryBatch.CONTENT_TYPE + ': ' + ODataQueryBatch.APPLICATION_JSON + ODataQueryBatch.NEWLINE;
        }
        if (Utils.isNullOrUndefined(httpOptions) || Utils.isNullOrUndefined(httpOptions.headers)) {
            return res;
        }
        for (const key of httpOptions.headers.keys()) {
            res += key + ': ' + httpOptions.headers.getAll(key) + ODataQueryBatch.NEWLINE;
        }
        return res;
    }
    /**
     * @return {?}
     */
    getUUID() {
        return UUID.UUID();
    }
}
ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX = '--';
ODataQueryBatch.BATCH_PREFIX = 'batch_';
ODataQueryBatch.CHANGESET_PREFIX = 'changeset_';
ODataQueryBatch.NEWLINE = '\r\n';
ODataQueryBatch.$BATCH = '$batch';
ODataQueryBatch.HTTP11 = 'HTTP/1.1';
ODataQueryBatch.ODATA_VERSION = 'OData-Version';
ODataQueryBatch.CONTENT_TYPE = 'Content-Type';
ODataQueryBatch.ACCEPT = 'Accept';
ODataQueryBatch.CONTENT_TRANSFER_ENCODING = 'Content-Transfer-Encoding';
ODataQueryBatch.CONTENT_ID = 'Content-ID';
ODataQueryBatch.VERSION_4_0 = '4.0';
ODataQueryBatch.MULTIPART_MIXED = 'multipart/mixed';
ODataQueryBatch.MULTIPART_MIXED_BOUNDARY = 'multipart/mixed;boundary=';
ODataQueryBatch.APPLICATION_HTTP = 'application/http';
ODataQueryBatch.BINARY = 'binary';
ODataQueryBatch.APPLICATION_JSON = 'application/json';
if (false) {
    /** @type {?} */
    ODataQueryBatch.BOUNDARY_PREFIX_SUFFIX;
    /** @type {?} */
    ODataQueryBatch.BATCH_PREFIX;
    /** @type {?} */
    ODataQueryBatch.CHANGESET_PREFIX;
    /** @type {?} */
    ODataQueryBatch.NEWLINE;
    /** @type {?} */
    ODataQueryBatch.$BATCH;
    /** @type {?} */
    ODataQueryBatch.HTTP11;
    /** @type {?} */
    ODataQueryBatch.ODATA_VERSION;
    /** @type {?} */
    ODataQueryBatch.CONTENT_TYPE;
    /** @type {?} */
    ODataQueryBatch.ACCEPT;
    /** @type {?} */
    ODataQueryBatch.CONTENT_TRANSFER_ENCODING;
    /** @type {?} */
    ODataQueryBatch.CONTENT_ID;
    /** @type {?} */
    ODataQueryBatch.VERSION_4_0;
    /** @type {?} */
    ODataQueryBatch.MULTIPART_MIXED;
    /** @type {?} */
    ODataQueryBatch.MULTIPART_MIXED_BOUNDARY;
    /** @type {?} */
    ODataQueryBatch.APPLICATION_HTTP;
    /** @type {?} */
    ODataQueryBatch.BINARY;
    /** @type {?} */
    ODataQueryBatch.APPLICATION_JSON;
    /** @type {?} */
    ODataQueryBatch.prototype.requests;
    /** @type {?} */
    ODataQueryBatch.prototype.batchBoundary;
    /** @type {?} */
    ODataQueryBatch.prototype.changesetBoundary;
    /** @type {?} */
    ODataQueryBatch.prototype.changesetID;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGEtcXVlcnktYmF0Y2guanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vZGF0YS12NC1uZy8iLCJzb3VyY2VzIjpbImxpYi9vZGF0YS1xdWVyeS9vZGF0YS1xdWVyeS1iYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFLckMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDOzs7SUFJMUQsTUFBRyxFQUFFLE9BQUksRUFBRSxNQUFHLEVBQUUsUUFBSyxFQUFFLFNBQU07OztjQUE3QixHQUFHO2NBQUUsSUFBSTtjQUFFLEdBQUc7Y0FBRSxLQUFLO2NBQUUsTUFBTTtBQUcvQixNQUFNOzs7Ozs7O0lBQ0osWUFDUyxRQUNBLFlBQ0EsTUFDQTtRQUhBLFdBQU0sR0FBTixNQUFNO1FBQ04sZUFBVSxHQUFWLFVBQVU7UUFDVixTQUFJLEdBQUosSUFBSTtRQUNKLGdCQUFXLEdBQVgsV0FBVztLQUFvQjtDQUN6Qzs7Ozs7Ozs7Ozs7QUFFRCxNQUFNLHNCQUF1QixTQUFRLGtCQUFrQjs7Ozs7SUErQnJELFlBQVksWUFBMEIsRUFBRSxXQUFtQjtRQUN6RCxLQUFLLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ2pDLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDL0QsS0FBSyxDQUFDLDBCQUEwQixDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM3RCxLQUFLLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FB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LGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgVVVJRCB9IGZyb20gJ2FuZ3VsYXIyLXV1aWQnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgT0RhdGFSZXNwb25zZSB9IGZyb20gJy4uL29kYXRhLXJlc3BvbnNlL29kYXRhLXJlc3BvbnNlJztcbmltcG9ydCB7IEh0dHBPcHRpb25zSSB9IGZyb20gJy4uL29kYXRhLXNlcnZpY2UvaHR0cC1vcHRpb25zJztcbmltcG9ydCB7IE9EYXRhU2VydmljZSB9IGZyb20gJy4uL29kYXRhLXNlcnZpY2Uvb2RhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcbmltcG9ydCB7IE9EYXRhUXVlcnkgfSBmcm9tICcuL29kYXRhLXF1ZXJ5JztcbmltcG9ydCB7IE9EYXRhUXVlcnlBYnN0cmFjdCB9IGZyb20gJy4vb2RhdGEtcXVlcnktYWJzdHJhY3QnO1xuXG5cbmV4cG9ydCBlbnVtIE1ldGhvZCB7XG4gIEdFVCwgUE9TVCwgUFVULCBQQVRDSCwgREVMRVRFXG59XG5cbmV4cG9ydCBjbGFzcyBCYXRjaFJlcXVlc3Qge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgbWV0aG9kOiBNZXRob2QsXG4gICAgcHVibGljIG9kYXRhUXVlcnk6IE9EYXRhUXVlcnksXG4gICAgcHVibGljIGJvZHk/OiBhbnksXG4gICAgcHVibGljIGh0dHBPcHRpb25zPzogSHR0cE9wdGlvbnNJKSB7IH1cbn1cblxuZXhwb3J0IGNsYXNzIE9EYXRhUXVlcnlCYXRjaCBleHRlbmRzIE9EYXRhUXVlcnlBYnN0cmFjdCB7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEJPVU5EQVJZX1BSRUZJWF9TVUZGSVggPSAnLS0nO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBCQVRDSF9QUkVGSVggPSAnYmF0Y2hfJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQ0hBTkdFU0VUX1BSRUZJWCA9ICdjaGFuZ2VzZXRfJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTkVXTElORSA9ICdcXHJcXG4nO1xuXG4gIC8vIENPTlNUQU5UIFNFR01FTlRTXG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5ICRCQVRDSCA9ICckYmF0Y2gnO1xuXG4gIC8vIEhFQURFUlNcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgSFRUUDExID0gJ0hUVFAvMS4xJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgT0RBVEFfVkVSU0lPTiA9ICdPRGF0YS1WZXJzaW9uJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQ09OVEVOVF9UWVBFID0gJ0NvbnRlbnQtVHlwZSc7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEFDQ0VQVCA9ICdBY2NlcHQnO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBDT05URU5UX1RSQU5TRkVSX0VOQ09ESU5HID0gJ0NvbnRlbnQtVHJhbnNmZXItRW5jb2RpbmcnO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBDT05URU5UX0lEID0gJ0NvbnRlbnQtSUQnO1xuXG4gIC8vIEhFQURFUiBWQUxVRVNcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVkVSU0lPTl80XzAgPSAnNC4wJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTVVMVElQQVJUX01JWEVEID0gJ211bHRpcGFydC9taXhlZCc7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IE1VTFRJUEFSVF9NSVhFRF9CT1VOREFSWSA9ICdtdWx0aXBhcnQvbWl4ZWQ7Ym91bmRhcnk9JztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQVBQTElDQVRJT05fSFRUUCA9ICdhcHBsaWNhdGlvbi9odHRwJztcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgQklOQVJZID0gJ2JpbmFyeSc7XG4gIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IEFQUExJQ0FUSU9OX0pTT04gPSAnYXBwbGljYXRpb24vanNvbic7XG5cbiAgLy8gVkFSSUFCTEVTXG4gIHByaXZhdGUgcmVxdWVzdHM6IEJhdGNoUmVxdWVzdFtdO1xuICBwcml2YXRlIGJhdGNoQm91bmRhcnk6IHN0cmluZztcbiAgcHJpdmF0ZSBjaGFuZ2VzZXRCb3VuZGFyeTogc3RyaW5nO1xuICBwcml2YXRlIGNoYW5nZXNldElEOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Iob2RhdGFTZXJ2aWNlOiBPRGF0YVNlcnZpY2UsIHNlcnZpY2VSb290OiBzdHJpbmcpIHtcbiAgICBzdXBlcihvZGF0YVNlcnZpY2UsIHNlcnZpY2VSb290KTtcbiAgICBVdGlscy5yZXF1aXJlTm90TnVsbE5vclVuZGVmaW5lZChvZGF0YVNlcnZpY2UsICdvZGF0YVNlcnZpY2UnKTtcbiAgICBVdGlscy5yZXF1aXJlTm90TnVsbE5vclVuZGVmaW5lZChzZXJ2aWNlUm9vdCwgJ3NlcnZpY2VSb290Jyk7XG4gICAgVXRpbHMucmVxdWlyZU5vdEVtcHR5KHNlcnZpY2VSb290LCAnc2VydmljZVJvb3QnKTtcbiAgICB0aGlzLnF1ZXJ5U3RyaW5nID0gVXRpbHMuYXBwZW5kU2VnbWVudChzZXJ2aWNlUm9vdCwgT0RhdGFRdWVyeUJhdGNoLiRCQVRDSCk7XG4gICAgdGhpcy5yZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuYmF0Y2hCb3VuZGFyeSA9IE9EYXRhUXVlcnlCYXRjaC5CQVRDSF9QUkVGSVggKyB0aGlzLmdldFVVSUQoKTtcbiAgICB0aGlzLmNoYW5nZXNldEJvdW5kYXJ5ID0gbnVsbDtcbiAgICB0aGlzLmNoYW5nZXNldElEID0gMTtcbiAgfVxuXG4gIGdldChvZGF0YVF1ZXJ5OiBPRGF0YVF1ZXJ5LCBodHRwT3B0aW9ucz86IEh0dHBPcHRpb25zSSk6IE9EYXRhUXVlcnlCYXRjaCB7XG4gICAgVXRpbHMucmVxdWlyZU5vdE51bGxOb3JVbmRlZmluZWQob2RhdGFRdWVyeSwgJ29kYXRhUXVlcnknKTtcbiAgICB0aGlzLnJlcXVlc3RzLnB1c2gobmV3IEJhdGNoUmVxdWVzdChNZXRob2QuR0VULCBvZGF0YVF1ZXJ5LCB1bmRlZmluZWQsIGh0dHBPcHRpb25zKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwb3N0KG9kYXRhUXVlcnk6IE9EYXRhUXVlcnksIGJvZHk6IGFueSwgaHR0cE9wdGlvbnM/OiBIdHRwT3B0aW9uc0kpOiBPRGF0YVF1ZXJ5QmF0Y2gge1xuICAgIFV0aWxzLnJlcXVpcmVOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUXVlcnksICdvZGF0YVF1ZXJ5Jyk7XG4gICAgdGhpcy5yZXF1ZXN0cy5wdXNoKG5ldyBCYXRjaFJlcXVlc3QoTWV0aG9kLlBPU1QsIG9kYXRhUXVlcnksIGJvZHksIGh0dHBPcHRpb25zKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdXQob2RhdGFRdWVyeTogT0RhdGFRdWVyeSwgYm9keTogYW55LCBodHRwT3B0aW9ucz86IEh0dHBPcHRpb25zSSk6IE9EYXRhUXVlcnlCYXRjaCB7XG4gICAgVXRpbHMucmVxdWlyZU5vdE51bGxOb3JVbmRlZmluZWQob2RhdGFRdWVyeSwgJ29kYXRhUXVlcnknKTtcbiAgICB0aGlzLnJlcXVlc3RzLnB1c2gobmV3IEJhdGNoUmVxdWVzdChNZXRob2QuUFVULCBvZGF0YVF1ZXJ5LCBib2R5LCBodHRwT3B0aW9ucykpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcGF0Y2gob2RhdGFRdWVyeTogT0RhdGFRdWVyeSwgYm9keTogYW55LCBodHRwT3B0aW9ucz86IEh0dHBPcHRpb25zSSk6IE9EYXRhUXVlcnlCYXRjaCB7XG4gICAgVXRpbHMucmVxdWlyZU5vdE51bGxOb3JVbmRlZmluZWQob2RhdGFRdWVyeSwgJ29kYXRhUXVlcnknKTtcbiAgICB0aGlzLnJlcXVlc3RzLnB1c2gobmV3IEJhdGNoUmVxdWVzdChNZXRob2QuUEFUQ0gsIG9kYXRhUXVlcnksIGJvZHksIGh0dHBPcHRpb25zKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBkZWxldGUob2RhdGFRdWVyeTogT0RhdGFRdWVyeSwgaHR0cE9wdGlvbnM/OiBIdHRwT3B0aW9uc0kpOiBPRGF0YVF1ZXJ5QmF0Y2gge1xuICAgIFV0aWxzLnJlcXVpcmVOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUXVlcnksICdvZGF0YVF1ZXJ5Jyk7XG4gICAgdGhpcy5yZXF1ZXN0cy5wdXNoKG5ldyBCYXRjaFJlcXVlc3QoTWV0aG9kLkRFTEVURSwgb2RhdGFRdWVyeSwgdW5kZWZpbmVkLCBodHRwT3B0aW9ucykpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZXhlY3V0ZShodHRwT3B0aW9ucz86IEh0dHBPcHRpb25zSSk6IE9ic2VydmFibGU8T0RhdGFSZXNwb25zZT4ge1xuICAgIC8vIHNldCBoZWFkZXJzXG4gICAgaWYgKFV0aWxzLmlzTnVsbE9yVW5kZWZpbmVkKGh0dHBPcHRpb25zKSkge1xuICAgICAgaHR0cE9wdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgaWYgKFV0aWxzLmlzTnVsbE9yVW5kZWZpbmVkKGh0dHBPcHRpb25zLmhlYWRlcnMpKSB7XG4gICAgICBodHRwT3B0aW9ucy5oZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKCk7XG4gICAgfVxuICAgIGh0dHBPcHRpb25zLmhlYWRlcnMgPSBodHRwT3B0aW9ucy5oZWFkZXJzLnNldChPRGF0YVF1ZXJ5QmF0Y2guT0RBVEFfVkVSU0lPTiwgT0RhdGFRdWVyeUJhdGNoLlZFUlNJT05fNF8wKTtcbiAgICBodHRwT3B0aW9ucy5oZWFkZXJzID0gaHR0cE9wdGlvbnMuaGVhZGVycy5zZXQoT0RhdGFRdWVyeUJhdGNoLkNPTlRFTlRfVFlQRSwgT0RhdGFRdWVyeUJhdGNoLk1VTFRJUEFSVF9NSVhFRF9CT1VOREFSWSArIHRoaXMuYmF0Y2hCb3VuZGFyeSk7XG4gICAgaHR0cE9wdGlvbnMuaGVhZGVycyA9IGh0dHBPcHRpb25zLmhlYWRlcnMuc2V0KE9EYXRhUXVlcnlCYXRjaC5BQ0NFUFQsIE9EYXRhUXVlcnlCYXRjaC5NVUxUSVBBUlRfTUlYRUQpO1xuXG4gICAgLy8gc2VuZCByZXF1ZXN0XG4gICAgcmV0dXJuIHRoaXMub2RhdGFTZXJ2aWNlLnBvc3QodGhpcywgdGhpcy5nZXRCb2R5KCksIGh0dHBPcHRpb25zKTtcbiAgfVxuXG4gIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucXVlcnlTdHJpbmc7XG4gIH1cblxuICBnZXRCb2R5KCk6IHN0cmluZyB7XG4gICAgbGV0IHJlcyA9ICcnO1xuXG4gICAgZm9yIChjb25zdCByZXF1ZXN0IG9mIHRoaXMucmVxdWVzdHMpIHtcbiAgICAgIGNvbnN0IG1ldGhvZDogTWV0aG9kID0gcmVxdWVzdC5tZXRob2Q7XG4gICAgICBjb25zdCBvZGF0YVF1ZXJ5OiBPRGF0YVF1ZXJ5ID0gcmVxdWVzdC5vZGF0YVF1ZXJ5O1xuICAgICAgY29uc3QgaHR0cE9wdGlvbnM6IEh0dHBPcHRpb25zSSA9IHJlcXVlc3QuaHR0cE9wdGlvbnM7XG4gICAgICBjb25zdCBib2R5OiBhbnkgPSByZXF1ZXN0LmJvZHk7XG5cbiAgICAgIC8vIGlmIG1ldGhvZCBpcyBHRVQgYW5kIHRoZXJlIGlzIGEgY2hhbmdlc2V0IGJvdW5kYXJ5IG9wZW4gdGhlbiBjbG9zZSBpdFxuICAgICAgaWYgKG1ldGhvZCA9PT0gTWV0aG9kLkdFVCAmJiBVdGlscy5pc05vdE51bGxOb3JVbmRlZmluZWQodGhpcy5jaGFuZ2VzZXRCb3VuZGFyeSkpIHtcbiAgICAgICAgcmVzICs9IE9EYXRhUXVlcnlCYXRjaC5CT1VOREFSWV9QUkVGSVhfU1VGRklYICsgdGhpcy5jaGFuZ2VzZXRCb3VuZGFyeSArIE9EYXRhUXVlcnlCYXRjaC5CT1VOREFSWV9QUkVGSVhfU1VGRklYICsgT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG4gICAgICAgIHRoaXMuY2hhbmdlc2V0Qm91bmRhcnkgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB0aGVyZSBpcyBubyBjaGFuZ2VzZXQgYm91bmRhcnkgb3BlbiB0aGVuIG9wZW4gYSBiYXRjaCBib3VuZGFyeVxuICAgICAgaWYgKFV0aWxzLmlzTnVsbE9yVW5kZWZpbmVkKHRoaXMuY2hhbmdlc2V0Qm91bmRhcnkpKSB7XG4gICAgICAgIHJlcyArPSBPRGF0YVF1ZXJ5QmF0Y2guQk9VTkRBUllfUFJFRklYX1NVRkZJWCArIHRoaXMuYmF0Y2hCb3VuZGFyeSArIE9EYXRhUXVlcnlCYXRjaC5ORVdMSU5FO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBtZXRob2QgaXMgbm90IEdFVCBhbmQgdGhlcmUgaXMgbm8gY2hhbmdlc2V0IGJvdW5kYXJ5IG9wZW4gdGhlbiBvcGVuIGEgY2hhbmdlc2V0IGJvdW5kYXJ5XG4gICAgICBpZiAobWV0aG9kICE9PSBNZXRob2QuR0VUKSB7XG4gICAgICAgIGlmIChVdGlscy5pc051bGxPclVuZGVmaW5lZCh0aGlzLmNoYW5nZXNldEJvdW5kYXJ5KSkge1xuICAgICAgICAgIHRoaXMuY2hhbmdlc2V0Qm91bmRhcnkgPSBPRGF0YVF1ZXJ5QmF0Y2guQ0hBTkdFU0VUX1BSRUZJWCArIHRoaXMuZ2V0VVVJRCgpO1xuICAgICAgICAgIHJlcyArPSBPRGF0YVF1ZXJ5QmF0Y2guQ09OVEVOVF9UWVBFICsgJzogJyArIE9EYXRhUXVlcnlCYXRjaC5NVUxUSVBBUlRfTUlYRURfQk9VTkRBUlkgKyB0aGlzLmNoYW5nZXNldEJvdW5kYXJ5ICsgT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG4gICAgICAgICAgcmVzICs9IE9EYXRhUXVlcnlCYXRjaC5ORVdMSU5FO1xuICAgICAgICB9XG4gICAgICAgIHJlcyArPSBPRGF0YVF1ZXJ5QmF0Y2guQk9VTkRBUllfUFJFRklYX1NVRkZJWCArIHRoaXMuY2hhbmdlc2V0Qm91bmRhcnkgKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICAgIH1cblxuICAgICAgcmVzICs9IE9EYXRhUXVlcnlCYXRjaC5DT05URU5UX1RZUEUgKyAnOiAnICsgT0RhdGFRdWVyeUJhdGNoLkFQUExJQ0FUSU9OX0hUVFAgKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICAgIHJlcyArPSBPRGF0YVF1ZXJ5QmF0Y2guQ09OVEVOVF9UUkFOU0ZFUl9FTkNPRElORyArICc6ICcgKyBPRGF0YVF1ZXJ5QmF0Y2guQklOQVJZICsgT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG5cbiAgICAgIGlmIChtZXRob2QgIT09IE1ldGhvZC5HRVQpIHtcbiAgICAgICAgcmVzICs9IE9EYXRhUXVlcnlCYXRjaC5DT05URU5UX0lEICsgJzogJyArIHRoaXMuY2hhbmdlc2V0SUQrKyArIE9EYXRhUXVlcnlCYXRjaC5ORVdMSU5FO1xuICAgICAgfVxuXG4gICAgICByZXMgKz0gT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG4gICAgICByZXMgKz0gTWV0aG9kW21ldGhvZF0gKyAnICcgKyBvZGF0YVF1ZXJ5ICsgJyAnICsgT0RhdGFRdWVyeUJhdGNoLkhUVFAxMSArIE9EYXRhUXVlcnlCYXRjaC5ORVdMSU5FO1xuXG4gICAgICByZXMgKz0gdGhpcy5nZXRIZWFkZXJzKG1ldGhvZCwgaHR0cE9wdGlvbnMpO1xuXG4gICAgICByZXMgKz0gT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG4gICAgICBpZiAobWV0aG9kID09PSBNZXRob2QuR0VUIHx8IG1ldGhvZCA9PT0gTWV0aG9kLkRFTEVURSkge1xuICAgICAgICByZXMgKz0gT0RhdGFRdWVyeUJhdGNoLk5FV0xJTkU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMgKz0gSlNPTi5zdHJpbmdpZnkoYm9keSkgKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVzLmxlbmd0aCkge1xuICAgICAgaWYgKFV0aWxzLmlzTm90TnVsbE5vclVuZGVmaW5lZCh0aGlzLmNoYW5nZXNldEJvdW5kYXJ5KSkge1xuICAgICAgICByZXMgKz0gT0RhdGFRdWVyeUJhdGNoLkJPVU5EQVJZX1BSRUZJWF9TVUZGSVggKyB0aGlzLmNoYW5nZXNldEJvdW5kYXJ5ICsgT0RhdGFRdWVyeUJhdGNoLkJPVU5EQVJZX1BSRUZJWF9TVUZGSVggKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICAgICAgdGhpcy5jaGFuZ2VzZXRCb3VuZGFyeSA9IG51bGw7XG4gICAgICB9XG4gICAgICByZXMgKz0gT0RhdGFRdWVyeUJhdGNoLkJPVU5EQVJZX1BSRUZJWF9TVUZGSVggKyB0aGlzLmJhdGNoQm91bmRhcnkgKyBPRGF0YVF1ZXJ5QmF0Y2guQk9VTkRBUllfUFJFRklYX1NVRkZJWDtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldEhlYWRlcnMobWV0aG9kOiBNZXRob2QsIGh0dHBPcHRpb25zOiBIdHRwT3B0aW9uc0kpOiBzdHJpbmcge1xuICAgIGxldCByZXMgPSAnJztcblxuICAgIGlmIChtZXRob2QgPT09IE1ldGhvZC5QT1NUIHx8IG1ldGhvZCA9PT0gTWV0aG9kLlBBVENIIHx8IG1ldGhvZCA9PT0gTWV0aG9kLlBVVCkge1xuICAgICAgcmVzICs9IE9EYXRhUXVlcnlCYXRjaC5DT05URU5UX1RZUEUgKyAnOiAnICsgT0RhdGFRdWVyeUJhdGNoLkFQUExJQ0FUSU9OX0pTT04gKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICB9XG5cbiAgICBpZiAoVXRpbHMuaXNOdWxsT3JVbmRlZmluZWQoaHR0cE9wdGlvbnMpIHx8IFV0aWxzLmlzTnVsbE9yVW5kZWZpbmVkKGh0dHBPcHRpb25zLmhlYWRlcnMpKSB7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIGh0dHBPcHRpb25zLmhlYWRlcnMua2V5cygpKSB7XG4gICAgICByZXMgKz0ga2V5ICsgJzogJyArIGh0dHBPcHRpb25zLmhlYWRlcnMuZ2V0QWxsKGtleSkgKyBPRGF0YVF1ZXJ5QmF0Y2guTkVXTElORTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgZ2V0VVVJRCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBVVUlELlVVSUQoKTtcbiAgfVxufVxuIl19