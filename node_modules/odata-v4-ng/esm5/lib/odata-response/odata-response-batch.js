/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { HttpHeaders, HttpResponse } from '@angular/common/http';
import { Utils } from '../utils/utils';
import { ODataResponse } from './odata-response';
import { ODataResponseAbstract } from './odata-response-abstract';
var ODataResponseBatch = /** @class */ (function (_super) {
    tslib_1.__extends(ODataResponseBatch, _super);
    function ODataResponseBatch(httpResponse) {
        var _this = _super.call(this, httpResponse) || this;
        _this.odataResponses = [];
        _this.parseResponses();
        return _this;
    }
    /**
     * @return {?}
     */
    ODataResponseBatch.prototype.getODataResponses = /**
     * @return {?}
     */
    function () {
        return this.odataResponses;
    };
    /**
     * @return {?}
     */
    ODataResponseBatch.prototype.parseResponses = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var contentType = this.getHttpResponse().headers.get(ODataResponseBatch.CONTENT_TYPE);
        /** @type {?} */
        var boundaryDelimiterBatch = this.getBoundaryDelimiter(contentType);
        /** @type {?} */
        var boundaryEndBatch = this.getBoundaryEnd(boundaryDelimiterBatch);
        /** @type {?} */
        var batchBody = this.getBodyAsText();
        /** @type {?} */
        var batchBodyLines = batchBody.split(ODataResponseBatch.NEWLINE);
        /** @type {?} */
        var odataResponseCS;
        /** @type {?} */
        var contentId;
        /** @type {?} */
        var boundaryDelimiterCS;
        /** @type {?} */
        var boundaryEndCS;
        /** @type {?} */
        var batchPartStartIndex;
        for (var index = 0; index < batchBodyLines.length; index++) {
            /** @type {?} */
            var batchBodyLine = batchBodyLines[index];
            if (batchBodyLine.startsWith(ODataResponseBatch.CONTENT_TYPE)) {
                /** @type {?} */
                var contentTypeValue = this.getHeaderValue(batchBodyLine);
                if (contentTypeValue === ODataResponseBatch.MULTIPART_MIXED) {
                    odataResponseCS = [];
                    contentId = undefined;
                    boundaryDelimiterCS = this.getBoundaryDelimiter(batchBodyLine);
                    boundaryEndCS = this.getBoundaryEnd(boundaryDelimiterCS);
                    batchPartStartIndex = undefined;
                }
                continue;
            }
            else if (Utils.isNotNullNorUndefined(odataResponseCS) && batchBodyLine.startsWith(ODataResponseBatch.CONTENT_ID)) {
                contentId = Number(this.getHeaderValue(batchBodyLine));
            }
            else if (batchBodyLine.startsWith(ODataResponseBatch.HTTP11)) {
                batchPartStartIndex = index;
            }
            else if (batchBodyLine === boundaryDelimiterBatch || batchBodyLine === boundaryDelimiterCS
                || batchBodyLine === boundaryEndBatch || batchBodyLine === boundaryEndCS) {
                if (!batchPartStartIndex) {
                    continue;
                }
                /** @type {?} */
                var odataResponse = this.createODataResponse(batchBodyLines, batchPartStartIndex, index - 1);
                if (Utils.isNotNullNorUndefined(odataResponseCS)) {
                    odataResponseCS[contentId] = odataResponse;
                }
                else {
                    this.odataResponses.push(odataResponse);
                }
                if (batchBodyLine === boundaryDelimiterBatch || batchBodyLine === boundaryDelimiterCS) {
                    batchPartStartIndex = index + 1;
                }
                else if (batchBodyLine === boundaryEndBatch || batchBodyLine === boundaryEndCS) {
                    if (Utils.isNotNullNorUndefined(odataResponseCS)) {
                        try {
                            for (var odataResponseCS_1 = tslib_1.__values(odataResponseCS), odataResponseCS_1_1 = odataResponseCS_1.next(); !odataResponseCS_1_1.done; odataResponseCS_1_1 = odataResponseCS_1.next()) {
                                var response = odataResponseCS_1_1.value;
                                if (Utils.isNotNullNorUndefined(response)) {
                                    this.odataResponses.push(response);
                                }
                            }
                        }
                        catch (e_1_1) { e_1 = { error: e_1_1 }; }
                        finally {
                            try {
                                if (odataResponseCS_1_1 && !odataResponseCS_1_1.done && (_a = odataResponseCS_1.return)) _a.call(odataResponseCS_1);
                            }
                            finally { if (e_1) throw e_1.error; }
                        }
                    }
                    odataResponseCS = undefined;
                    boundaryDelimiterCS = undefined;
                    boundaryEndCS = undefined;
                    batchPartStartIndex = undefined;
                }
            }
        }
        var e_1, _a;
    };
    /**
     * @param {?} header
     * @return {?}
     */
    ODataResponseBatch.prototype.getHeaderValue = /**
     * @param {?} header
     * @return {?}
     */
    function (header) {
        /** @type {?} */
        var res = header.split(';')[0].trim();
        res = res.split(':')[1].trim();
        return res;
    };
    /**
     * @param {?} contentType
     * @return {?}
     */
    ODataResponseBatch.prototype.getBoundaryDelimiter = /**
     * @param {?} contentType
     * @return {?}
     */
    function (contentType) {
        /** @type {?} */
        var contentTypeParts = contentType.split(';');
        if (contentTypeParts.length === 2) {
            /** @type {?} */
            var boundary = contentType.split(';')[1].trim();
            /** @type {?} */
            var boundaryDelimiter = ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX + boundary.split('=')[1];
            return boundaryDelimiter;
        }
        else {
            return '';
        }
    };
    /**
     * @param {?} boundaryDelimiter
     * @return {?}
     */
    ODataResponseBatch.prototype.getBoundaryEnd = /**
     * @param {?} boundaryDelimiter
     * @return {?}
     */
    function (boundaryDelimiter) {
        if (!boundaryDelimiter.length) {
            return '';
        }
        /** @type {?} */
        var boundaryEnd = boundaryDelimiter + ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX;
        return boundaryEnd;
    };
    /**
     * @param {?} batchBodyLines
     * @param {?} batchPartStartIndex
     * @param {?} batchPartEndIndex
     * @return {?}
     */
    ODataResponseBatch.prototype.createODataResponse = /**
     * @param {?} batchBodyLines
     * @param {?} batchPartStartIndex
     * @param {?} batchPartEndIndex
     * @return {?}
     */
    function (batchBodyLines, batchPartStartIndex, batchPartEndIndex) {
        /** @type {?} */
        var index = batchPartStartIndex;
        /** @type {?} */
        var statusLine = batchBodyLines[index];
        /** @type {?} */
        var statusLineParts = batchBodyLines[index].split(' ');
        /** @type {?} */
        var status = statusLineParts[1];
        /** @type {?} */
        var statusTextIndex = statusLine.indexOf(status) + status.length + 1;
        /** @type {?} */
        var statusText = statusLine.substring(statusTextIndex);
        /** @type {?} */
        var httpHeaders = new HttpHeaders();
        for (++index; index <= batchPartEndIndex; index++) {
            /** @type {?} */
            var batchBodyLine = batchBodyLines[index];
            if (batchBodyLine === '') {
                break;
            }
            /** @type {?} */
            var batchBodyLineParts = batchBodyLine.split(': ');
            httpHeaders = httpHeaders.append(batchBodyLineParts[0].trim(), batchBodyLineParts[1].trim());
        }
        /** @type {?} */
        var body = '';
        for (; index <= batchPartEndIndex; index++) {
            body += batchBodyLines[index];
        }
        return new ODataResponse(new HttpResponse({
            body: body,
            headers: httpHeaders,
            status: Number(status),
            statusText: statusText
        }));
    };
    ODataResponseBatch.CONTENT_TYPE = 'Content-Type';
    ODataResponseBatch.CONTENT_ID = 'Content-ID';
    ODataResponseBatch.HTTP11 = 'HTTP/1.1';
    ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX = '--';
    ODataResponseBatch.NEWLINE = '\r\n';
    ODataResponseBatch.MULTIPART_MIXED = 'multipart/mixed';
    return ODataResponseBatch;
}(ODataResponseAbstract));
export { ODataResponseBatch };
if (false) {
    /** @type {?} */
    ODataResponseBatch.CONTENT_TYPE;
    /** @type {?} */
    ODataResponseBatch.CONTENT_ID;
    /** @type {?} */
    ODataResponseBatch.HTTP11;
    /** @type {?} */
    ODataResponseBatch.BOUNDARY_PREFIX_SUFFIX;
    /** @type {?} */
    ODataResponseBatch.NEWLINE;
    /** @type {?} */
    ODataResponseBatch.MULTIPART_MIXED;
    /** @type {?} */
    ODataResponseBatch.prototype.odataResponses;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2RhdGEtcmVzcG9uc2UtYmF0Y2guanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vZGF0YS12NC1uZy8iLCJzb3VyY2VzIjpbImxpYi9vZGF0YS1yZXNwb25zZS9vZGF0YS1yZXNwb25zZS1iYXRjaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFakUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7SUFFMUIsOENBQXFCO0lBVXpELDRCQUFZLFlBQWtDO1FBQTlDLFlBQ0ksa0JBQU0sWUFBWSxDQUFDLFNBR3RCO1FBRkcsS0FBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFDekIsS0FBSSxDQUFDLGNBQWMsRUFBRSxDQUFDOztLQUN6Qjs7OztJQUVELDhDQUFpQjs7O0lBQWpCO1FBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUM7S0FDOUI7Ozs7SUFFUywyQ0FBYzs7O0lBQXhCOztRQUNJLElBQU0sV0FBVyxHQUFXLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDOztRQUNoRyxJQUFNLHNCQUFzQixHQUFXLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsQ0FBQzs7UUFDOUUsSUFBTSxnQkFBZ0IsR0FBVyxJQUFJLENBQUMsY0FBYyxDQUFDLHNCQUFzQixDQUFDLENBQUM7O1FBRTdFLElBQU0sU0FBUyxHQUFXLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzs7UUFDL0MsSUFBTSxjQUFjLEdBQWEsU0FBUyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FB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QyxDQUFDLGFBQWEsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixLQUFLLENBQUM7YUFDVDs7WUFFRCxJQUFNLGtCQUFrQixHQUFhLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0QsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNoRzs7UUFFRCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxpQkFBaUIsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO1lBQ3pDLElBQUksSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDakM7UUFFRCxNQUFNLENBQUMsSUFBSSxhQUFhLENBQUMsSUFBSSxZQUFZLENBQUM7WUFDdEMsSUFBSSxFQUFFLElBQUk7WUFDVixPQUFPLEVBQUUsV0FBVztZQUNwQixNQUFNLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUN0QixVQUFVLEVBQUUsVUFBVTtTQUN6QixDQUFDLENBQUMsQ0FBQztLQUNQO3NDQXpJc0MsY0FBYztvQ0FDaEIsWUFBWTtnQ0FDaEIsVUFBVTtnREFDTSxJQUFJO2lDQUNuQixNQUFNO3lDQUNFLGlCQUFpQjs2QkFaL0Q7RUFNd0MscUJBQXFCO1NBQWhELGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBIZWFkZXJzLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuaW1wb3J0IHsgT0RhdGFSZXNwb25zZSB9IGZyb20gJy4vb2RhdGEtcmVzcG9uc2UnO1xuaW1wb3J0IHsgT0RhdGFSZXNwb25zZUFic3RyYWN0IH0gZnJvbSAnLi9vZGF0YS1yZXNwb25zZS1hYnN0cmFjdCc7XG5cbmV4cG9ydCBjbGFzcyBPRGF0YVJlc3BvbnNlQmF0Y2ggZXh0ZW5kcyBPRGF0YVJlc3BvbnNlQWJzdHJhY3Qge1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IENPTlRFTlRfVFlQRSA9ICdDb250ZW50LVR5cGUnO1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IENPTlRFTlRfSUQgPSAnQ29udGVudC1JRCc7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgSFRUUDExID0gJ0hUVFAvMS4xJztcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBCT1VOREFSWV9QUkVGSVhfU1VGRklYID0gJy0tJztcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBORVdMSU5FID0gJ1xcclxcbic7XG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgTVVMVElQQVJUX01JWEVEID0gJ211bHRpcGFydC9taXhlZCc7XG5cbiAgICBwcml2YXRlIG9kYXRhUmVzcG9uc2VzOiBPRGF0YVJlc3BvbnNlW107XG5cbiAgICBjb25zdHJ1Y3RvcihodHRwUmVzcG9uc2U6IEh0dHBSZXNwb25zZTxzdHJpbmc+KSB7XG4gICAgICAgIHN1cGVyKGh0dHBSZXNwb25zZSk7XG4gICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMgPSBbXTtcbiAgICAgICAgdGhpcy5wYXJzZVJlc3BvbnNlcygpO1xuICAgIH1cblxuICAgIGdldE9EYXRhUmVzcG9uc2VzKCk6IE9EYXRhUmVzcG9uc2VbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9kYXRhUmVzcG9uc2VzO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZVJlc3BvbnNlcygpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgY29udGVudFR5cGU6IHN0cmluZyA9IHRoaXMuZ2V0SHR0cFJlc3BvbnNlKCkuaGVhZGVycy5nZXQoT0RhdGFSZXNwb25zZUJhdGNoLkNPTlRFTlRfVFlQRSk7XG4gICAgICAgIGNvbnN0IGJvdW5kYXJ5RGVsaW1pdGVyQmF0Y2g6IHN0cmluZyA9IHRoaXMuZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoY29udGVudFR5cGUpO1xuICAgICAgICBjb25zdCBib3VuZGFyeUVuZEJhdGNoOiBzdHJpbmcgPSB0aGlzLmdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyQmF0Y2gpO1xuXG4gICAgICAgIGNvbnN0IGJhdGNoQm9keTogc3RyaW5nID0gdGhpcy5nZXRCb2R5QXNUZXh0KCk7XG4gICAgICAgIGNvbnN0IGJhdGNoQm9keUxpbmVzOiBzdHJpbmdbXSA9IGJhdGNoQm9keS5zcGxpdChPRGF0YVJlc3BvbnNlQmF0Y2guTkVXTElORSk7XG5cbiAgICAgICAgbGV0IG9kYXRhUmVzcG9uc2VDUzogT0RhdGFSZXNwb25zZVtdO1xuICAgICAgICBsZXQgY29udGVudElkOiBudW1iZXI7XG4gICAgICAgIGxldCBib3VuZGFyeURlbGltaXRlckNTO1xuICAgICAgICBsZXQgYm91bmRhcnlFbmRDUztcbiAgICAgICAgbGV0IGJhdGNoUGFydFN0YXJ0SW5kZXg7XG4gICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBiYXRjaEJvZHlMaW5lcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICAgIGNvbnN0IGJhdGNoQm9keUxpbmU6IHN0cmluZyA9IGJhdGNoQm9keUxpbmVzW2luZGV4XTtcblxuICAgICAgICAgICAgaWYgKGJhdGNoQm9keUxpbmUuc3RhcnRzV2l0aChPRGF0YVJlc3BvbnNlQmF0Y2guQ09OVEVOVF9UWVBFKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlVmFsdWU6IHN0cmluZyA9IHRoaXMuZ2V0SGVhZGVyVmFsdWUoYmF0Y2hCb2R5TGluZSk7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlVmFsdWUgPT09IE9EYXRhUmVzcG9uc2VCYXRjaC5NVUxUSVBBUlRfTUlYRUQpIHtcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXNwb25zZUNTID0gW107XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlEZWxpbWl0ZXJDUyA9IHRoaXMuZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoYmF0Y2hCb2R5TGluZSk7XG4gICAgICAgICAgICAgICAgICAgIGJvdW5kYXJ5RW5kQ1MgPSB0aGlzLmdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyQ1MpO1xuICAgICAgICAgICAgICAgICAgICBiYXRjaFBhcnRTdGFydEluZGV4ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoVXRpbHMuaXNOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUmVzcG9uc2VDUykgJiYgYmF0Y2hCb2R5TGluZS5zdGFydHNXaXRoKE9EYXRhUmVzcG9uc2VCYXRjaC5DT05URU5UX0lEKSkge1xuICAgICAgICAgICAgICAgIGNvbnRlbnRJZCA9IE51bWJlcih0aGlzLmdldEhlYWRlclZhbHVlKGJhdGNoQm9keUxpbmUpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYmF0Y2hCb2R5TGluZS5zdGFydHNXaXRoKE9EYXRhUmVzcG9uc2VCYXRjaC5IVFRQMTEpKSB7XG4gICAgICAgICAgICAgICAgYmF0Y2hQYXJ0U3RhcnRJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgfSBlbHNlIGlmIChiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeURlbGltaXRlckJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RGVsaW1pdGVyQ1NcbiAgICAgICAgICAgICAgICB8fCBiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeUVuZEJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RW5kQ1MpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWJhdGNoUGFydFN0YXJ0SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3Qgb2RhdGFSZXNwb25zZTogT0RhdGFSZXNwb25zZSA9IHRoaXMuY3JlYXRlT0RhdGFSZXNwb25zZShiYXRjaEJvZHlMaW5lcywgYmF0Y2hQYXJ0U3RhcnRJbmRleCwgaW5kZXggLSAxKTtcbiAgICAgICAgICAgICAgICBpZiAoVXRpbHMuaXNOb3ROdWxsTm9yVW5kZWZpbmVkKG9kYXRhUmVzcG9uc2VDUykpIHtcbiAgICAgICAgICAgICAgICAgICAgb2RhdGFSZXNwb25zZUNTW2NvbnRlbnRJZF0gPSBvZGF0YVJlc3BvbnNlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMucHVzaChvZGF0YVJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoYmF0Y2hCb2R5TGluZSA9PT0gYm91bmRhcnlEZWxpbWl0ZXJCYXRjaCB8fCBiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeURlbGltaXRlckNTKSB7XG4gICAgICAgICAgICAgICAgICAgIGJhdGNoUGFydFN0YXJ0SW5kZXggPSBpbmRleCArIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYXRjaEJvZHlMaW5lID09PSBib3VuZGFyeUVuZEJhdGNoIHx8IGJhdGNoQm9keUxpbmUgPT09IGJvdW5kYXJ5RW5kQ1MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFV0aWxzLmlzTm90TnVsbE5vclVuZGVmaW5lZChvZGF0YVJlc3BvbnNlQ1MpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlc3BvbnNlIG9mIG9kYXRhUmVzcG9uc2VDUykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChVdGlscy5pc05vdE51bGxOb3JVbmRlZmluZWQocmVzcG9uc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2RhdGFSZXNwb25zZXMucHVzaChyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9kYXRhUmVzcG9uc2VDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlEZWxpbWl0ZXJDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYm91bmRhcnlFbmRDUyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgYmF0Y2hQYXJ0U3RhcnRJbmRleCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0SGVhZGVyVmFsdWUoaGVhZGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBsZXQgcmVzOiBzdHJpbmcgPSBoZWFkZXIuc3BsaXQoJzsnKVswXS50cmltKCk7XG4gICAgICAgIHJlcyA9IHJlcy5zcGxpdCgnOicpWzFdLnRyaW0oKTtcbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0Qm91bmRhcnlEZWxpbWl0ZXIoY29udGVudFR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlUGFydHM6IHN0cmluZ1tdID0gY29udGVudFR5cGUuc3BsaXQoJzsnKTtcbiAgICAgICAgaWYgKGNvbnRlbnRUeXBlUGFydHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICBjb25zdCBib3VuZGFyeTogc3RyaW5nID0gY29udGVudFR5cGUuc3BsaXQoJzsnKVsxXS50cmltKCk7XG4gICAgICAgICAgICBjb25zdCBib3VuZGFyeURlbGltaXRlcjogc3RyaW5nID0gT0RhdGFSZXNwb25zZUJhdGNoLkJPVU5EQVJZX1BSRUZJWF9TVUZGSVggKyBib3VuZGFyeS5zcGxpdCgnPScpWzFdO1xuICAgICAgICAgICAgcmV0dXJuIGJvdW5kYXJ5RGVsaW1pdGVyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldEJvdW5kYXJ5RW5kKGJvdW5kYXJ5RGVsaW1pdGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAoIWJvdW5kYXJ5RGVsaW1pdGVyLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJvdW5kYXJ5RW5kOiBzdHJpbmcgPSBib3VuZGFyeURlbGltaXRlciArIE9EYXRhUmVzcG9uc2VCYXRjaC5CT1VOREFSWV9QUkVGSVhfU1VGRklYO1xuICAgICAgICByZXR1cm4gYm91bmRhcnlFbmQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGNyZWF0ZU9EYXRhUmVzcG9uc2UoYmF0Y2hCb2R5TGluZXM6IHN0cmluZ1tdLCBiYXRjaFBhcnRTdGFydEluZGV4OiBudW1iZXIsIGJhdGNoUGFydEVuZEluZGV4OiBudW1iZXIpOiBPRGF0YVJlc3BvbnNlIHtcbiAgICAgICAgbGV0IGluZGV4OiBudW1iZXIgPSBiYXRjaFBhcnRTdGFydEluZGV4O1xuICAgICAgICBjb25zdCBzdGF0dXNMaW5lOiBzdHJpbmcgPSBiYXRjaEJvZHlMaW5lc1tpbmRleF07XG4gICAgICAgIGNvbnN0IHN0YXR1c0xpbmVQYXJ0czogc3RyaW5nW10gPSBiYXRjaEJvZHlMaW5lc1tpbmRleF0uc3BsaXQoJyAnKTtcbiAgICAgICAgY29uc3Qgc3RhdHVzOiBzdHJpbmcgPSBzdGF0dXNMaW5lUGFydHNbMV07XG4gICAgICAgIGNvbnN0IHN0YXR1c1RleHRJbmRleCA9IHN0YXR1c0xpbmUuaW5kZXhPZihzdGF0dXMpICsgc3RhdHVzLmxlbmd0aCArIDE7XG4gICAgICAgIGNvbnN0IHN0YXR1c1RleHQ6IHN0cmluZyA9IHN0YXR1c0xpbmUuc3Vic3RyaW5nKHN0YXR1c1RleHRJbmRleCk7XG5cbiAgICAgICAgbGV0IGh0dHBIZWFkZXJzOiBIdHRwSGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgICAgICBmb3IgKCsraW5kZXg7IGluZGV4IDw9IGJhdGNoUGFydEVuZEluZGV4OyBpbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBiYXRjaEJvZHlMaW5lOiBzdHJpbmcgPSBiYXRjaEJvZHlMaW5lc1tpbmRleF07XG5cbiAgICAgICAgICAgIGlmIChiYXRjaEJvZHlMaW5lID09PSAnJykge1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBiYXRjaEJvZHlMaW5lUGFydHM6IHN0cmluZ1tdID0gYmF0Y2hCb2R5TGluZS5zcGxpdCgnOiAnKTtcbiAgICAgICAgICAgIGh0dHBIZWFkZXJzID0gaHR0cEhlYWRlcnMuYXBwZW5kKGJhdGNoQm9keUxpbmVQYXJ0c1swXS50cmltKCksIGJhdGNoQm9keUxpbmVQYXJ0c1sxXS50cmltKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGJvZHkgPSAnJztcbiAgICAgICAgZm9yICg7IGluZGV4IDw9IGJhdGNoUGFydEVuZEluZGV4OyBpbmRleCsrKSB7XG4gICAgICAgICAgICBib2R5ICs9IGJhdGNoQm9keUxpbmVzW2luZGV4XTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgT0RhdGFSZXNwb25zZShuZXcgSHR0cFJlc3BvbnNlKHtcbiAgICAgICAgICAgIGJvZHk6IGJvZHksXG4gICAgICAgICAgICBoZWFkZXJzOiBodHRwSGVhZGVycyxcbiAgICAgICAgICAgIHN0YXR1czogTnVtYmVyKHN0YXR1cyksXG4gICAgICAgICAgICBzdGF0dXNUZXh0OiBzdGF0dXNUZXh0XG4gICAgICAgIH0pKTtcbiAgICB9XG59XG4iXX0=